<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Espa帽olProf - Plataforma Educativa</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'></text></svg>">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React 18 -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel Standalone -->
    <script src="https://unpkg.com/@babel/standalone@7.23.4/babel.min.js"></script>
    
    <!-- Google API Client Library -->
    <script src="https://apis.google.com/js/api.js"></script>
    
    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <!-- Google Calendar Scheduling -->
    <link href="https://calendar.google.com/calendar/scheduling-button-script.css" rel="stylesheet">
    <script src="https://calendar.google.com/calendar/scheduling-button-script.js" async></script>
    
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
        }
        
        .editor-content {
            outline: none;
            min-height: 400px;
        }
        
        .editor-content:focus {
            outline: 2px solid #6366f1;
            outline-offset: -2px;
        }
        
        /* Iconos SVG personalizados */
        .icon {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }
        
        .icon-sm {
            width: 16px;
            height: 16px;
        }
        
        /* Estilos para ejercicios con evaluaci贸n */
        .exercise-input { 
            border: 1px solid #d1d5db; 
            padding: 4px 8px; 
            border-radius: 4px; 
            width: 100px;
        }
        .exercise-input.correct { 
            background-color: #dcfce7; 
            border-color: #16a34a; 
        }
        .exercise-input.incorrect { 
            background-color: #fee2e2; 
            border-color: #dc2626; 
        }
        .exercise-check-btn {
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px 5px;
        }
        .exercise-check-btn:hover {
            background-color: #2563eb;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useRef, useEffect } = React;
        
        // Iconos SVG personalizados (reemplazo de Lucide)
        const Icons = {
            User: () => (
                <svg className="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                </svg>
            ),
            Users: () => (
                <svg className="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
            ),
            Download: () => (
                <svg className="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7,10 12,15 17,10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
            ),
            MessageCircle: () => (
                <svg className="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
                </svg>
            ),
            Bold: () => (
                <svg className="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <path d="M6 4h8a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"/>
                    <path d="M6 12h9a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"/>
                </svg>
            ),
            Italic: () => (
                <svg className="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <line x1="19" y1="4" x2="10" y2="4"/>
                    <line x1="14" y1="20" x2="5" y2="20"/>
                    <line x1="15" y1="4" x2="9" y2="20"/>
                </svg>
            ),
            Underline: () => (
                <svg className="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <path d="M6 3v7a6 6 0 0 0 6 6 6 6 0 0 0 6-6V3"/>
                    <line x1="4" y1="21" x2="20" y2="21"/>
                </svg>
            ),
            AlignLeft: () => (
                <svg className="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <line x1="21" y1="10" x2="3" y2="10"/>
                    <line x1="21" y1="6" x2="3" y2="6"/>
                    <line x1="21" y1="14" x2="3" y2="14"/>
                    <line x1="21" y1="18" x2="3" y2="18"/>
                </svg>
            ),
            AlignCenter: () => (
                <svg className="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <line x1="18" y1="10" x2="6" y2="10"/>
                    <line x1="21" y1="6" x2="3" y2="6"/>
                    <line x1="21" y1="14" x2="3" y2="14"/>
                    <line x1="18" y1="18" x2="6" y2="18"/>
                </svg>
            ),
            AlignRight: () => (
                <svg className="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <line x1="21" y1="10" x2="9" y2="10"/>
                    <line x1="21" y1="6" x2="3" y2="6"/>
                    <line x1="21" y1="14" x2="3" y2="14"/>
                    <line x1="21" y1="18" x2="9" y2="18"/>
                </svg>
            ),
            List: () => (
                <svg className="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <line x1="8" y1="6" x2="21" y2="6"/>
                    <line x1="8" y1="12" x2="21" y2="12"/>
                    <line x1="8" y1="18" x2="21" y2="18"/>
                    <line x1="3" y1="6" x2="3.01" y2="6"/>
                    <line x1="3" y1="12" x2="3.01" y2="12"/>
                    <line x1="3" y1="18" x2="3.01" y2="18"/>
                </svg>
            ),
            ListOrdered: () => (
                <svg className="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <line x1="10" y1="6" x2="21" y2="6"/>
                    <line x1="10" y1="12" x2="21" y2="12"/>
                    <line x1="10" y1="18" x2="21" y2="18"/>
                    <path d="M4 6h1v4"/>
                    <path d="M4 10h2"/>
                    <path d="M6 18H4c0-1 2-2 2-3s-1-1.5-2-1"/>
                </svg>
            ),
            FileText: () => (
                <svg className="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14,2 14,8 20,8"/>
                    <line x1="16" y1="13" x2="8" y2="13"/>
                    <line x1="16" y1="17" x2="8" y2="17"/>
                    <polyline points="10,9 9,9 8,9"/>
                </svg>
            ),
            Eraser: () => (
                <svg className="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <path d="M7 21h10"/>
                    <path d="M5 21h4"/>
                    <path d="M19 21h-4"/>
                    <path d="M9 3L3 9l6 6 6-6-6-6z"/>
                    <path d="M12.5 5.5L16 9"/>
                </svg>
            ),
            Plus: () => (
                <svg className="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
            ),
            ArrowRight: () => (
                <svg className="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <line x1="5" y1="12" x2="19" y2="12"/>
                    <polyline points="12,5 19,12 12,19"/>
                </svg>
            ),
            Calendar: () => (
                <svg className="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                    <line x1="16" y1="2" x2="16" y2="6"/>
                    <line x1="8" y1="2" x2="8" y2="6"/>
                    <line x1="3" y1="10" x2="21" y2="10"/>
                </svg>
            ),
            Lightbulb: () => (
                <svg className="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <path d="M9 21h6"/>
                    <path d="M12 17v4"/>
                    <path d="M12 3a9 9 0 0 1 9 9 9 9 0 0 1-9 9 9 9 0 0 1-9-9 9 9 0 0 1 9-9z"/>
                </svg>
            )
        };

        // Configuraci贸n de APIs - Por seguridad, las keys deben ser proporcionadas por el usuario
        // o almacenadas en variables de entorno, no en el c贸digo fuente
        const getApiKeys = () => {
            // Intentar obtener las keys del localStorage primero
            let keys = {
                googleClientId: localStorage.getItem('GOOGLE_CLIENT_ID') || '',
                googleApiKey: localStorage.getItem('GOOGLE_API_KEY') || '',
                openaiApiKey: localStorage.getItem('OPENAI_API_KEY') || ''
            };
            
            // Si no existen, pedirlas al usuario
            if (!keys.googleClientId || !keys.googleApiKey || !keys.openaiApiKey) {
                console.warn('API keys no configuradas. Algunas funciones estar谩n deshabilitadas.');
            }
            
            return keys;
        };
        
        // Obtener las keys de forma segura
        const apiKeys = getApiKeys();
        const GOOGLE_CLIENT_ID = apiKeys.googleClientId;
        const GOOGLE_API_KEY = apiKeys.googleApiKey;
        const OPENAI_API_KEY = apiKeys.openaiApiKey;
        const DISCOVERY_DOCS = ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'];
        const SCOPES = 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/drive.appdata';

        // Biblioteca de ejercicios pre-generados
        const exerciseLibrary = {
            A1: {
                vocabulary: [
                    {
                        id: 'vocab-a1-1',
                        title: 'La Familia',
                        content: `<h3>Une cada definici贸n con la palabra correcta</h3>
                        <p><strong>Definiciones:</strong></p>
                        <p>1. El hijo de mi hermano/a: _______</p>
                        <p>2. La madre de mi madre: _______</p>
                        <p>3. El esposo de mi hija: _______</p>
                        <p>4. La hermana de mi padre: _______</p>
                        <p>5. Los padres de mi esposo/a: _______</p>
                        <p><strong>Banco de palabras:</strong> sobrino, abuela, yerno, t铆a, suegros, primo, abuelo</p>`,
                        answers: { 1: 'sobrino', 2: 'abuela', 3: 'yerno', 4: 't铆a', 5: 'suegros' }
                    }
                ],
                conjugation: [
                    {
                        id: 'conj-a1-1',
                        title: 'Verbo SER - Presente',
                        content: `<h3>Completa la conjugaci贸n del verbo SER en presente</h3>
                        <table border="1" style="width: 100%; border-collapse: collapse;">
                        <tr><th>Pronombre</th><th>Conjugaci贸n</th></tr>
                        <tr><td>Yo</td><td><input type="text" data-answer="soy" class="exercise-input" /></td></tr>
                        <tr><td>T煤</td><td><input type="text" data-answer="eres" class="exercise-input" /></td></tr>
                        <tr><td>l/Ella</td><td><input type="text" data-answer="es" class="exercise-input" /></td></tr>
                        <tr><td>Nosotros</td><td><input type="text" data-answer="somos" class="exercise-input" /></td></tr>
                        <tr><td>Vosotros</td><td><input type="text" data-answer="sois" class="exercise-input" /></td></tr>
                        <tr><td>Ellos/Ellas</td><td><input type="text" data-answer="son" class="exercise-input" /></td></tr>
                        </table>`,
                        type: 'fill-in'
                    }
                ],
                completion: [
                    {
                        id: 'comp-a1-1',
                        title: 'Saludos y Presentaciones',
                        content: `<h3>Completa las frases con las palabras del banco</h3>
                        <p>1. 隆Hola! 驴C贸mo _______ llamas?</p>
                        <p>2. _______ llamo Mar铆a.</p>
                        <p>3. 驴De _______ eres?</p>
                        <p>4. Soy _______ Espa帽a.</p>
                        <p>5. Mucho _______ en conocerte.</p>
                        <p><strong>Banco de palabras:</strong> te, me, d贸nde, de, gusto, est谩, soy</p>`,
                        answers: { 1: 'te', 2: 'Me', 3: 'd贸nde', 4: 'de', 5: 'gusto' }
                    }
                ]
            },
            B1: {
                vocabulary: [
                    {
                        id: 'vocab-b1-1',
                        title: 'El Trabajo',
                        content: `<h3>Une cada definici贸n con la profesi贸n correcta</h3>
                        <p><strong>Definiciones:</strong></p>
                        <p>1. Persona que dise帽a edificios y estructuras: _______</p>
                        <p>2. Profesional que defiende a personas en juicios: _______</p>
                        <p>3. Especialista en preparar comidas en restaurantes: _______</p>
                        <p>4. Persona que escribe art铆culos para peri贸dicos: _______</p>
                        <p>5. Profesional que atiende a pacientes enfermos: _______</p>
                        <p><strong>Banco de palabras:</strong> arquitecto, abogado, chef, periodista, enfermero, ingeniero, contador</p>`,
                        answers: { 1: 'arquitecto', 2: 'abogado', 3: 'chef', 4: 'periodista', 5: 'enfermero' }
                    }
                ]
            }
        };

        const EspanolProfApp = () => {
            // Estados principales
            const [currentStudent, setCurrentStudent] = useState(null);
            const [students, setStudents] = useState([]);
            const [sessions, setSessions] = useState({}); // Estructura: { studentId: { sessionNumber: { content, date, title } } }
            const [currentSession, setCurrentSession] = useState(1);
            const [sessionDate, setSessionDate] = useState(new Date().toISOString().split('T')[0]);
            const [vocabulary, setVocabulary] = useState({});
            
            // Estados del editor colaborativo
            const editorRef = useRef(null);
            const [editorContent, setEditorContent] = useState('');
            const [currentSessionContent, setCurrentSessionContent] = useState(''); // Contenido de la sesi贸n actual
            const [collaborators, setCollaborators] = useState([]);
            const [userName, setUserName] = useState('Profesor');
            const [userColor, setUserColor] = useState('#3B82F6');
            
            // Estados de herramientas del editor
            const [textFormat, setTextFormat] = useState({
                bold: false,
                italic: false,
                underline: false,
                fontSize: 16,
                color: '#000000',
                align: 'left'
            });
            
            // Estados de sesi贸n
            const [sessionData, setSessionData] = useState({
                objectives: '',
                achievements: '',
                progress: '',
                notes: ''
            });
            
            // Estados de herramientas
            const [showTemplateModal, setShowTemplateModal] = useState(false);
            const [activePanel, setActivePanel] = useState('session');
            const [showChat, setShowChat] = useState(false);
            const [chatMessages, setChatMessages] = useState([]);
            const [newMessage, setNewMessage] = useState('');
            const [showDriveFiles, setShowDriveFiles] = useState(false);
            const [showConfigModal, setShowConfigModal] = useState(false);
            const [configKeys, setConfigKeys] = useState({
                googleClientId: localStorage.getItem('GOOGLE_CLIENT_ID') || '',
                googleApiKey: localStorage.getItem('GOOGLE_API_KEY') || '',
                openaiApiKey: localStorage.getItem('OPENAI_API_KEY') || ''
            });
            
            // Estados para herramientas de IA
            const [verbToConjugate, setVerbToConjugate] = useState('');
            const [selectedTense, setSelectedTense] = useState('Presente');
            const [conjugationResult, setConjugationResult] = useState('');
            const [isGeneratingExercise, setIsGeneratingExercise] = useState(false);
            
            // Estados para vocabulario
            const [showAddVocab, setShowAddVocab] = useState(false);
            const [newWord, setNewWord] = useState({ word: '', definition: '', example: '' });
            
            // Estados para sistema de progreso
            const [studentProgress, setStudentProgress] = useState({});
            const [badges, setBadges] = useState({});
            
            // Estados de conectividad
            const [gdriveConnected, setGdriveConnected] = useState(false);
            const [webrtcConnected, setWebrtcConnected] = useState(false);
            const [roomId, setRoomId] = useState('');
            
            // Estados de Google Drive
            const [isSignedIn, setIsSignedIn] = useState(false);
            const [driveFiles, setDriveFiles] = useState([]);
            const [syncStatus, setSyncStatus] = useState('disconnected'); // disconnected, syncing, synced, error
            
            // Google Identity Services - usando useRef para mantener referencias
            const tokenClientRef = useRef(null);
            const accessTokenRef = useRef(null);
            
            // Templates predefinidos
            const templates = [
                {
                    id: 'conjugation',
                    name: 'Tabla de Conjugaci贸n',
                    content: `
                        <h2 style="color: #1f2937; margin-bottom: 16px;">Conjugaci贸n del Verbo: _______</h2>
                        <table style="width: 100%; border-collapse: collapse; margin: 20px 0; border: 1px solid #d1d5db;">
                            <tr style="background-color: #f3f4f6;">
                                <th style="border: 1px solid #d1d5db; padding: 12px; text-align: left;">Pronombre</th>
                                <th style="border: 1px solid #d1d5db; padding: 12px; text-align: left;">Presente</th>
                                <th style="border: 1px solid #d1d5db; padding: 12px; text-align: left;">Pret茅rito</th>
                            </tr>
                            <tr><td style="border: 1px solid #d1d5db; padding: 8px;">Yo</td><td style="border: 1px solid #d1d5db; padding: 8px;">_______</td><td style="border: 1px solid #d1d5db; padding: 8px;">_______</td></tr>
                            <tr><td style="border: 1px solid #d1d5db; padding: 8px;">T煤</td><td style="border: 1px solid #d1d5db; padding: 8px;">_______</td><td style="border: 1px solid #d1d5db; padding: 8px;">_______</td></tr>
                            <tr><td style="border: 1px solid #d1d5db; padding: 8px;">l/Ella</td><td style="border: 1px solid #d1d5db; padding: 8px;">_______</td><td style="border: 1px solid #d1d5db; padding: 8px;">_______</td></tr>
                            <tr><td style="border: 1px solid #d1d5db; padding: 8px;">Nosotros</td><td style="border: 1px solid #d1d5db; padding: 8px;">_______</td><td style="border: 1px solid #d1d5db; padding: 8px;">_______</td></tr>
                            <tr><td style="border: 1px solid #d1d5db; padding: 8px;">Vosotros</td><td style="border: 1px solid #d1d5db; padding: 8px;">_______</td><td style="border: 1px solid #d1d5db; padding: 8px;">_______</td></tr>
                            <tr><td style="border: 1px solid #d1d5db; padding: 8px;">Ellos/Ellas</td><td style="border: 1px solid #d1d5db; padding: 8px;">_______</td><td style="border: 1px solid #d1d5db; padding: 8px;">_______</td></tr>
                        </table>
                    `
                },
                {
                    id: 'vocabulary',
                    name: 'Lista de Vocabulario',
                    content: `
                        <h2 style="color: #1f2937; margin-bottom: 16px;">Vocabulario - Lecci贸n ___</h2>
                        <div style="margin: 20px 0;">
                            <h3 style="color: #374151; margin-bottom: 12px;">Nuevas Palabras:</h3>
                            <ul style="list-style-type: disc; margin-left: 20px; line-height: 1.6;">
                                <li><strong>Palabra:</strong> _______ - <em>Definici贸n</em></li>
                                <li><strong>Palabra:</strong> _______ - <em>Definici贸n</em></li>
                                <li><strong>Palabra:</strong> _______ - <em>Definici贸n</em></li>
                                <li><strong>Palabra:</strong> _______ - <em>Definici贸n</em></li>
                                <li><strong>Palabra:</strong> _______ - <em>Definici贸n</em></li>
                            </ul>
                            <h3 style="color: #374151; margin: 20px 0 12px 0;">Frases de Ejemplo:</h3>
                            <ol style="margin-left: 20px; line-height: 1.6;">
                                <li>_______________________________</li>
                                <li>_______________________________</li>
                                <li>_______________________________</li>
                            </ol>
                        </div>
                    `
                },
                {
                    id: 'exercise',
                    name: 'Ejercicio de Completar',
                    content: `
                        <h2 style="color: #1f2937; margin-bottom: 16px;">Ejercicio: Completa las Frases</h2>
                        <div style="margin: 20px 0;">
                            <p style="margin-bottom: 16px;"><strong>Instrucciones:</strong> Completa las siguientes frases con la palabra correcta.</p>
                            <div style="margin: 15px 0; padding: 15px; background-color: #f9fafb; border-left: 4px solid #3b82f6; border-radius: 4px;">
                                <p style="margin: 8px 0;">1. Me gusta _______ m煤sica en mi tiempo libre.</p>
                                <p style="margin: 8px 0;">2. 驴_______ hora es?</p>
                                <p style="margin: 8px 0;">3. Mi hermana _______ estudiando medicina.</p>
                                <p style="margin: 8px 0;">4. _______ ma帽ana vamos al parque.</p>
                                <p style="margin: 8px 0;">5. El libro _______ muy interesante.</p>
                            </div>
                            <p style="margin-top: 16px;"><strong>Palabras disponibles:</strong> escuchar, qu茅, est谩, ma帽ana, es</p>
                        </div>
                    `
                }
            ];
            
            // Funciones de Google Drive
            const initGoogleDrive = () => {
                // Detectar el origen actual
                const currentOrigin = window.location.origin;
                console.log('Current origin:', currentOrigin);
                
                if (!window.gapi) {
                    console.error('Google API no est谩 cargada');
                    setSyncStatus('disconnected');
                    return;
                }
                
                // Cargar el cliente GAPI para Drive API
                gapi.load('client', () => {
                    console.log('GAPI client cargado correctamente');
                    
                    // Inicializar el cliente con API key
                    gapi.client.init({
                        apiKey: GOOGLE_API_KEY,
                        discoveryDocs: DISCOVERY_DOCS,
                    }).then(() => {
                        console.log('Cliente GAPI inicializado');
                        
                        // Inicializar Google Identity Services
                        if (window.google && window.google.accounts && window.google.accounts.oauth2) {
                            console.log('Inicializando tokenClient con:', {
                                client_id: GOOGLE_CLIENT_ID,
                                scope: SCOPES
                            });
                            
                            tokenClientRef.current = google.accounts.oauth2.initTokenClient({
                                client_id: GOOGLE_CLIENT_ID,
                                scope: SCOPES,
                                callback: (response) => {
                                    if (response.error) {
                                        console.error('Error obteniendo token:', response);
                                        setSyncStatus('error');
                                        return;
                                    }
                                    
                                    // Token obtenido exitosamente
                                    accessTokenRef.current = response.access_token;
                                    console.log('Token obtenido exitosamente');
                                    
                                    // Configurar el token en gapi
                                    gapi.client.setToken({ access_token: accessTokenRef.current });
                                    
                                    // Actualizar el estado a conectado
                                    setIsSignedIn(true);
                                    setGdriveConnected(true);
                                    setSyncStatus('synced');
                                    
                                    // Cargar archivos de Drive
                                    loadDriveFiles();
                                }
                            });
                            console.log('Google Identity Services inicializado');
                        } else {
                            console.error('Google Identity Services no est谩 cargado');
                            setSyncStatus('error');
                        }
                    }).catch(error => {
                        console.error('Error inicializando GAPI client:', error);
                        setSyncStatus('error');
                    });
                });
            };
            
            const updateSigninStatus = (isSignedIn) => {
                setIsSignedIn(isSignedIn);
                setGdriveConnected(isSignedIn);
                if (isSignedIn) {
                    setSyncStatus('synced');
                    loadDriveFiles();
                } else {
                    setSyncStatus('disconnected');
                }
            };
            
            const handleAuthClick = async () => {
                try {
                    if (isSignedIn) {
                        // Desconectar: revocar el token
                        if (accessTokenRef.current) {
                            google.accounts.oauth2.revoke(accessTokenRef.current, () => {
                                console.log('Token revocado');
                            });
                        }
                        
                        // Limpiar el token y actualizar el estado
                        accessTokenRef.current = null;
                        gapi.client.setToken(null);
                        setIsSignedIn(false);
                        setGdriveConnected(false);
                        setSyncStatus('disconnected');
                        setDriveFiles([]);
                        console.log('Usuario desconectado');
                    } else {
                        // Conectar: solicitar autorizaci贸n
                        console.log('Estado del tokenClient:', {
                            tokenClientRef: tokenClientRef,
                            tokenClientRefCurrent: tokenClientRef.current,
                            googleAccounts: window.google && window.google.accounts,
                            googleOAuth2: window.google && window.google.accounts && window.google.accounts.oauth2
                        });
                        
                        if (tokenClientRef.current) {
                            console.log('Iniciando proceso de autenticaci贸n...');
                            tokenClientRef.current.requestAccessToken({ prompt: 'consent' });
                        } else {
                            console.error('Cliente de token no inicializado');
                            alert('Error: Sistema de autenticaci贸n no inicializado. Recarga la p谩gina.');
                        }
                    }
                } catch (error) {
                    console.error('Error en autenticaci贸n:', error);
                    alert(`Error de autenticaci贸n: ${error.message || 'Error desconocido'}`);
                }
            };
            
            // Funci贸n para obtener o crear la carpeta espanolprof
            const getOrCreateFolder = async () => {
                try {
                    // Buscar si la carpeta ya existe
                    const searchResponse = await gapi.client.drive.files.list({
                        'q': "name='espanolprof' and mimeType='application/vnd.google-apps.folder' and trashed=false",
                        'fields': 'files(id, name)'
                    });
                    
                    if (searchResponse.result.files && searchResponse.result.files.length > 0) {
                        // La carpeta ya existe
                        console.log('Carpeta espanolprof encontrada:', searchResponse.result.files[0].id);
                        return searchResponse.result.files[0].id;
                    } else {
                        // Crear la carpeta
                        console.log('Creando carpeta espanolprof...');
                        const createResponse = await gapi.client.drive.files.create({
                            'resource': {
                                'name': 'espanolprof',
                                'mimeType': 'application/vnd.google-apps.folder'
                            },
                            'fields': 'id'
                        });
                        console.log('Carpeta creada:', createResponse.result.id);
                        return createResponse.result.id;
                    }
                } catch (error) {
                    console.error('Error al obtener/crear carpeta:', error);
                    throw error;
                }
            };
            
            // Funci贸n para obtener o crear carpeta del alumno/grupo
            const getOrCreateStudentFolder = async (studentName) => {
                try {
                    // Primero obtener la carpeta principal espanolprof
                    const mainFolderId = await getOrCreateFolder();
                    
                    // Buscar si existe la carpeta del alumno
                    const searchResponse = await gapi.client.drive.files.list({
                        'q': `name='${studentName}' and mimeType='application/vnd.google-apps.folder' and '${mainFolderId}' in parents and trashed=false`,
                        'fields': 'files(id, name)'
                    });
                    
                    if (searchResponse.result.files && searchResponse.result.files.length > 0) {
                        console.log(`Carpeta del alumno ${studentName} encontrada:`, searchResponse.result.files[0].id);
                        return searchResponse.result.files[0].id;
                    } else {
                        // Crear la carpeta del alumno
                        console.log(`Creando carpeta para ${studentName}...`);
                        const createResponse = await gapi.client.drive.files.create({
                            'resource': {
                                'name': studentName,
                                'mimeType': 'application/vnd.google-apps.folder',
                                'parents': [mainFolderId]
                            },
                            'fields': 'id'
                        });
                        console.log(`Carpeta creada para ${studentName}:`, createResponse.result.id);
                        return createResponse.result.id;
                    }
                } catch (error) {
                    console.error('Error al obtener/crear carpeta del alumno:', error);
                    throw error;
                }
            };
            
            const loadDriveFiles = async () => {
                try {
                    // Primero obtener el ID de la carpeta
                    const folderId = await getOrCreateFolder();
                    
                    // Buscar archivos dentro de la carpeta
                    const response = await gapi.client.drive.files.list({
                        'pageSize': 100,
                        'fields': 'files(id, name, modifiedTime)',
                        'q': `'${folderId}' in parents and name contains 'espanol-prof' and trashed = false`
                    });
                    
                    setDriveFiles(response.result.files || []);
                } catch (error) {
                    console.error('Error loading files:', error);
                    setSyncStatus('error');
                }
            };
            
            // Funci贸n para guardar sesi贸n individual del alumno
            const saveSessionToGoogleDrive = async (studentName, sessionNumber, content) => {
                if (!isSignedIn) return;
                
                setSyncStatus('syncing');
                
                try {
                    // Obtener carpeta del alumno
                    const studentFolderId = await getOrCreateStudentFolder(studentName);
                    
                    const sessionData = {
                        studentName: studentName,
                        sessionNumber: sessionNumber,
                        date: sessionDate,
                        content: content,
                        vocabulary: vocabulary[`${studentName}_${sessionNumber}`] || [],
                        lastModified: new Date().toISOString()
                    };
                    
                    const boundary = '-------314159265358979323846';
                    const delimiter = "\r\n--" + boundary + "\r\n";
                    const close_delim = "\r\n--" + boundary + "--";
                    
                    const metadata = {
                        'name': `sesion-${sessionNumber}-${sessionDate}.json`,
                        'mimeType': 'application/json',
                        'parents': [studentFolderId]
                    };
                    
                    const multipartRequestBody =
                        delimiter +
                        'Content-Type: application/json\r\n\r\n' +
                        JSON.stringify(metadata) +
                        delimiter +
                        'Content-Type: application/json\r\n\r\n' +
                        JSON.stringify(sessionData, null, 2) +
                        close_delim;
                    
                    const response = await gapi.client.request({
                        'path': '/upload/drive/v3/files',
                        'method': 'POST',
                        'params': {'uploadType': 'multipart'},
                        'headers': {
                            'Content-Type': 'multipart/related; boundary="' + boundary + '"'
                        },
                        'body': multipartRequestBody
                    });
                    
                    console.log(`Sesi贸n ${sessionNumber} guardada para ${studentName}:`, response.result);
                    setSyncStatus('synced');
                } catch (error) {
                    console.error('Error saving session:', error);
                    setSyncStatus('error');
                }
            };
            
            const saveToGoogleDrive = async () => {
                if (!isSignedIn) return;
                
                setSyncStatus('syncing');
                
                const data = {
                    sessions,
                    vocabulary,
                    editorContent,
                    students,
                    lastModified: new Date().toISOString()
                };
                
                const boundary = '-------314159265358979323846';
                const delimiter = "\r\n--" + boundary + "\r\n";
                const close_delim = "\r\n--" + boundary + "--";
                
                // Obtener el ID de la carpeta
                const folderId = await getOrCreateFolder();
                
                const metadata = {
                    'name': `espanol-prof-data-${new Date().toISOString().split('T')[0]}.json`,
                    'mimeType': 'application/json',
                    'parents': [folderId]  // Especificar la carpeta padre
                };
                
                const multipartRequestBody =
                    delimiter +
                    'Content-Type: application/json\r\n\r\n' +
                    JSON.stringify(metadata) +
                    delimiter +
                    'Content-Type: application/json\r\n\r\n' +
                    JSON.stringify(data, null, 2) +
                    close_delim;
                
                try {
                    const response = await gapi.client.request({
                        'path': '/upload/drive/v3/files',
                        'method': 'POST',
                        'params': {'uploadType': 'multipart'},
                        'headers': {
                            'Content-Type': 'multipart/related; boundary="' + boundary + '"'
                        },
                        'body': multipartRequestBody
                    });
                    
                    console.log('File saved to Google Drive in espanolprof folder:', response.result);
                    setSyncStatus('synced');
                    loadDriveFiles(); // Recargar lista de archivos
                } catch (error) {
                    console.error('Error saving to Google Drive:', error);
                    setSyncStatus('error');
                }
            };
            
            const loadFromGoogleDrive = async (fileId) => {
                if (!isSignedIn) return;
                
                setSyncStatus('syncing');
                
                try {
                    const response = await gapi.client.drive.files.get({
                        fileId: fileId,
                        alt: 'media'
                    });
                    
                    const data = response.result;
                    
                    // Cargar los datos
                    if (data.sessions) setSessions(data.sessions);
                    if (data.vocabulary) setVocabulary(data.vocabulary);
                    if (data.editorContent) {
                        setEditorContent(data.editorContent);
                        if (editorRef.current) {
                            editorRef.current.innerHTML = data.editorContent;
                        }
                    }
                    if (data.students) setStudents(data.students);
                    
                    setSyncStatus('synced');
                    alert('Datos cargados desde Google Drive');
                } catch (error) {
                    console.error('Error loading from Google Drive:', error);
                    setSyncStatus('error');
                }
            };
            
            // Funci贸n para cargar sesi贸n individual de un alumno
            const loadSessionFromGoogleDrive = async (studentName, sessionNumber) => {
                if (!isSignedIn) return;
                
                setSyncStatus('syncing');
                
                try {
                    // Obtener carpeta del alumno
                    const studentFolderId = await getOrCreateStudentFolder(studentName);
                    
                    // Buscar el archivo de la sesi贸n
                    const searchResponse = await gapi.client.drive.files.list({
                        'q': `'${studentFolderId}' in parents and name contains 'sesion-${sessionNumber}' and trashed=false`,
                        'fields': 'files(id, name, modifiedTime)',
                        'orderBy': 'modifiedTime desc'
                    });
                    
                    if (searchResponse.result.files && searchResponse.result.files.length > 0) {
                        const fileId = searchResponse.result.files[0].id;
                        
                        // Cargar el contenido del archivo
                        const response = await gapi.client.drive.files.get({
                            fileId: fileId,
                            alt: 'media'
                        });
                        
                        const sessionData = response.result;
                        
                        // Actualizar el contenido de la sesi贸n actual
                        setCurrentSessionContent(sessionData.content || '');
                        if (editorRef.current) {
                            editorRef.current.innerHTML = sessionData.content || '';
                        }
                        
                        // Actualizar vocabulario espec铆fico de la sesi贸n si existe
                        if (sessionData.vocabulary) {
                            setVocabulary(prev => ({
                                ...prev,
                                [`${studentName}_${sessionNumber}`]: sessionData.vocabulary
                            }));
                        }
                        
                        console.log(`Sesi贸n ${sessionNumber} cargada para ${studentName}`);
                        setSyncStatus('synced');
                    } else {
                        // No existe la sesi贸n, crear contenido vac铆o
                        setCurrentSessionContent('');
                        if (editorRef.current) {
                            editorRef.current.innerHTML = `<h2>Sesi贸n ${sessionNumber} - ${studentName}</h2><p>Contenido de la sesi贸n...</p>`;
                        }
                        setSyncStatus('synced');
                    }
                } catch (error) {
                    console.error('Error loading session:', error);
                    setSyncStatus('error');
                }
            };
            
            // Funciones de OpenAI
            const generateExerciseWithAI = async (type, level) => {
                try {
                    const prompts = {
                        'conjugation': `Crea un ejercicio de conjugaci贸n para nivel ${level}. 
                        INSTRUCCIONES: 
                        1. Elige un verbo com煤n en infinitivo
                        2. Crea una tabla vac铆a con 6 pronombres (yo, t煤, 茅l/ella, nosotros, vosotros, ellos/ellas)
                        3. Pide conjugar en 2 tiempos verbales espec铆ficos
                        4. NO incluyas las respuestas, solo espacios en blanco
                        5. Formato HTML con tabla
                        
                        EJEMPLO de formato deseado:
                        <h3>Ejercicio: Conjuga el verbo "hablar"</h3>
                        <table border="1">
                        <tr><th>Pronombre</th><th>Presente</th><th>Pret茅rito</th></tr>
                        <tr><td>Yo</td><td>_______</td><td>_______</td></tr>
                        </table>`,
                        
                        'vocabulary': `Crea un ejercicio de vocabulario para nivel ${level} sobre vida cotidiana.
                        INSTRUCCIONES:
                        1. Proporciona 5 definiciones SIN las palabras
                        2. Crea un banco de palabras con 7 opciones (5 correctas + 2 distractoras)
                        3. Los estudiantes deben emparejar definiciones con palabras
                        4. NO incluyas las respuestas correctas
                        5. Formato HTML claro
                        
                        EJEMPLO de formato:
                        <h3>Ejercicio: Une cada definici贸n con la palabra correcta</h3>
                        <p><strong>Definiciones:</strong></p>
                        <p>1. Objeto que suena para despertarte por la ma帽ana: _______</p>
                        <p><strong>Banco de palabras:</strong> reloj, despertador, l谩mpara, tel茅fono, radio, ventana, puerta</p>`,
                        
                        'completion': `Crea un ejercicio de completar frases para nivel ${level}.
                        INSTRUCCIONES:
                        1. Escribe 5 frases con contextos claros
                        2. Deja espacios en blanco para palabras clave
                        3. Proporciona un banco de palabras mezcladas (no en orden)
                        4. Las frases deben tener sentido completo
                        5. Cada palabra del banco se usa solo una vez
                        
                        EJEMPLO:
                        <h3>Completa las frases con las palabras del banco</h3>
                        <p>1. Me gusta _______ m煤sica en mi tiempo libre.</p>
                        <p>2. 驴_______ hora es?</p>
                        <p><strong>Banco de palabras:</strong> escuchar, qu茅, est谩, viene, trabajar</p>`,
                        
                        'conversation': `Crea un ejercicio de comprensi贸n de di谩logo para nivel ${level}.
                        INSTRUCCIONES:
                        1. Escribe un di谩logo corto entre 2 personas (situaci贸n cotidiana)
                        2. M谩ximo 6 intercambios de di谩logo
                        3. Crea 4 preguntas de comprensi贸n con opciones m煤ltiples
                        4. NO incluyas las respuestas correctas
                        5. Las preguntas deben verificar comprensi贸n, no memoria
                        
                        EJEMPLO:
                        <h3>Lee el di谩logo y responde:</h3>
                        <div style="background: #f0f0f0; padding: 10px;">
                        Ana: 驴Tienes planes para el fin de semana?
                        Luis: S铆, voy al cine con mi hermana.
                        </div>
                        <p>1. 驴Con qui茅n va Luis al cine? a) Solo b) Con Ana c) Con su hermana</p>`
                    };
                    
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${OPENAI_API_KEY}`
                        },
                        body: JSON.stringify({
                            model: 'gpt-3.5-turbo',
                            messages: [
                                {
                                    role: 'system',
                                    content: 'Eres un profesor de espa帽ol experto. IMPORTANTE: Crea ejercicios INTERACTIVOS sin respuestas incluidas. Los estudiantes deben completar/resolver el ejercicio. Usa HTML simple para formato. NO incluyas las soluciones en el ejercicio.'
                                },
                                {
                                    role: 'user',
                                    content: prompts[type] || prompts['vocabulary']
                                }
                            ],
                            temperature: 0.7,
                            max_tokens: 500
                        })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`Error ${response.status}: ${errorData.error?.message || 'Error desconocido'}`);
                    }
                    
                    const data = await response.json();
                    if (data.choices && data.choices[0]) {
                        return data.choices[0].message.content;
                    }
                    throw new Error('No se pudo generar el ejercicio');
                } catch (error) {
                    console.error('Error generando ejercicio:', error);
                    alert(`Error al generar ejercicio: ${error.message}`);
                    return null;
                }
            };
            
            const conjugateVerb = async (verb, tense) => {
                try {
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${OPENAI_API_KEY}`
                        },
                        body: JSON.stringify({
                            model: 'gpt-3.5-turbo',
                            messages: [
                                {
                                    role: 'system',
                                    content: 'Eres un experto en conjugaci贸n de verbos espa帽oles. Proporciona conjugaciones precisas.'
                                },
                                {
                                    role: 'user',
                                    content: `Conjuga el verbo "${verb}" en ${tense}. Formato: pronombre - conjugaci贸n (uno por l铆nea)`
                                }
                            ],
                            temperature: 0.3,
                            max_tokens: 200
                        })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`Error ${response.status}: ${errorData.error?.message || 'Error desconocido'}`);
                    }
                    
                    const data = await response.json();
                    if (data.choices && data.choices[0]) {
                        return data.choices[0].message.content;
                    }
                    throw new Error('No se pudo conjugar el verbo');
                } catch (error) {
                    console.error('Error conjugando verbo:', error);
                    return `Error: ${error.message}`;
                }
            };
            
            useEffect(() => {
                // Cargar datos guardados
                const savedData = localStorage.getItem('espanol-prof-data');
                if (savedData) {
                    try {
                        const data = JSON.parse(savedData);
                        setSessions(data.sessions || {});
                        setVocabulary(data.vocabulary || {});
                        setEditorContent(data.editorContent || '');
                    } catch (e) {
                        console.log('Error loading data:', e);
                    }
                }
                
                // Cargar estudiantes
                const savedStudents = localStorage.getItem('espanol-prof-students');
                if (savedStudents) {
                    try {
                        const parsedStudents = JSON.parse(savedStudents);
                        setStudents(Array.isArray(parsedStudents) ? parsedStudents : []);
                    } catch (e) {
                        setStudents([]);
                    }
                }
                
                // Configurar editor
                if (editorRef.current) {
                    editorRef.current.innerHTML = editorContent;
                }
                
                // Simular colaboradores conectados
                setTimeout(() => {
                    setWebrtcConnected(true);
                    setCollaborators([
                        { id: 'user1', name: 'Estudiante 1', color: '#EF4444', lastUpdate: Date.now() },
                        { id: 'user2', name: 'Estudiante 2', color: '#10B981', lastUpdate: Date.now() }
                    ]);
                }, 2000);
                
                // Inicializar Google Drive API
                const initializeGoogleServices = () => {
                    console.log('Verificando servicios de Google...', {
                        gapi: !!window.gapi,
                        google: !!window.google,
                        googleAccounts: window.google && !!window.google.accounts,
                        googleOAuth2: window.google && window.google.accounts && !!window.google.accounts.oauth2
                    });
                    
                    if (window.gapi && window.google && window.google.accounts && window.google.accounts.oauth2) {
                        console.log('Todos los servicios de Google est谩n cargados, inicializando...');
                        initGoogleDrive();
                    } else {
                        console.log('Esperando a que se carguen los servicios de Google...');
                        // Reintentar en 500ms
                        setTimeout(initializeGoogleServices, 500);
                    }
                };
                
                // Esperar un poco para que todos los scripts se carguen
                setTimeout(initializeGoogleServices, 1500);
            }, []);
            
            // Guardar datos autom谩ticamente
            useEffect(() => {
                const saveData = () => {
                    const data = {
                        sessions,
                        vocabulary,
                        editorContent
                    };
                    localStorage.setItem('espanol-prof-data', JSON.stringify(data));
                    
                    // Tambi茅n guardar en Google Drive si est谩 conectado
                    if (isSignedIn && syncStatus !== 'syncing') {
                        saveToGoogleDrive();
                    }
                };
                
                const interval = setInterval(saveData, 900000); // Guardar cada 15 minutos
                return () => clearInterval(interval);
            }, [sessions, vocabulary, editorContent, isSignedIn, syncStatus]);
            
            // Efecto para cargar sesi贸n cuando cambia el estudiante o n煤mero de sesi贸n
            useEffect(() => {
                if (currentStudent && isSignedIn) {
                    // Guardar la sesi贸n actual antes de cambiar si hay contenido
                    if (currentSessionContent && currentSessionContent.trim() !== '') {
                        saveSessionToGoogleDrive(currentStudent.name, currentSession, currentSessionContent);
                    }
                    
                    // Cargar la nueva sesi贸n
                    loadSessionFromGoogleDrive(currentStudent.name, currentSession);
                }
            }, [currentStudent, currentSession, isSignedIn]);
            
            // Manejar cambios en el editor
            const handleEditorChange = () => {
                if (editorRef.current) {
                    const content = editorRef.current.innerHTML;
                    setEditorContent(content);
                    setCurrentSessionContent(content); // Tambi茅n actualizar contenido de sesi贸n actual
                }
            };
            
            // Aplicar formato de texto
            const applyFormat = (command, value = null) => {
                document.execCommand(command, false, value);
                if (editorRef.current) {
                    editorRef.current.focus();
                }
                handleEditorChange();
                
                setTextFormat(prev => ({
                    ...prev,
                    bold: document.queryCommandState('bold'),
                    italic: document.queryCommandState('italic'),
                    underline: document.queryCommandState('underline')
                }));
            };
            
            // Insertar ejercicio de la biblioteca
            const insertLibraryExercise = (exercise) => {
                if (editorRef.current) {
                    const editor = editorRef.current;
                    editor.focus();
                    
                    const exerciseDiv = document.createElement('div');
                    exerciseDiv.innerHTML = `<div style="border: 2px solid #059669; padding: 16px; margin: 16px 0; border-radius: 8px; background-color: #f0fdfa;">
                        <h3 style="color: #047857; margin-bottom: 12px;"> ${exercise.title}</h3>
                        ${exercise.content}
                    </div>`;
                    
                    editor.appendChild(exerciseDiv);
                    handleEditorChange();
                    
                    // Registrar actividad para el progreso
                    recordActivity('exercise_completed', exercise.id);
                    
                    // Agregar bot贸n de evaluaci贸n si el ejercicio tiene respuestas
                    if (exercise.answers || exercise.type === 'fill-in') {
                        setTimeout(() => {
                            addEvaluationButton(exerciseDiv, exercise);
                        }, 100);
                    }
                    
                    editor.scrollTop = editor.scrollHeight;
                }
            };
            
            // Agregar bot贸n de evaluaci贸n a un ejercicio
            const addEvaluationButton = (container, exercise) => {
                const buttonContainer = document.createElement('div');
                buttonContainer.innerHTML = `
                    <button class="exercise-check-btn" onclick="checkExercise('${exercise.id}')">
                         Verificar Respuestas
                    </button>
                    <button class="exercise-check-btn" onclick="showAnswers('${exercise.id}')" style="background-color: #059669;">
                        锔 Mostrar Respuestas
                    </button>
                `;
                container.appendChild(buttonContainer);
                
                // Guardar las respuestas en el DOM para acceso posterior
                container.dataset.exerciseAnswers = JSON.stringify(exercise.answers || {});
                container.dataset.exerciseType = exercise.type || 'standard';
            };
            
            // Funci贸n global para verificar ejercicios (accesible desde onclick)
            window.checkExercise = (exerciseId) => {
                const exerciseContainer = document.querySelector(`[data-exercise-id="${exerciseId}"]`) || 
                                         Array.from(document.querySelectorAll('[data-exercise-answers]')).find(el => 
                                             el.querySelector('.exercise-check-btn')
                                         );
                
                if (!exerciseContainer) return;
                
                const answers = JSON.parse(exerciseContainer.dataset.exerciseAnswers || '{}');
                const type = exerciseContainer.dataset.exerciseType;
                
                let correctCount = 0;
                let totalCount = 0;
                
                if (type === 'fill-in') {
                    // Verificar inputs con data-answer
                    const inputs = exerciseContainer.querySelectorAll('.exercise-input[data-answer]');
                    inputs.forEach(input => {
                        const userAnswer = input.value.trim().toLowerCase();
                        const correctAnswer = input.dataset.answer.toLowerCase();
                        totalCount++;
                        
                        if (userAnswer === correctAnswer) {
                            input.classList.remove('incorrect');
                            input.classList.add('correct');
                            correctCount++;
                        } else {
                            input.classList.remove('correct');
                            input.classList.add('incorrect');
                        }
                    });
                } else {
                    // Verificar respuestas est谩ndar basadas en n煤meros
                    Object.keys(answers).forEach(questionNum => {
                        const input = exerciseContainer.querySelector(`input[data-question="${questionNum}"]`) ||
                                     exerciseContainer.querySelector(`span[data-question="${questionNum}"] input`);
                        
                        if (input) {
                            const userAnswer = input.value.trim().toLowerCase();
                            const correctAnswer = answers[questionNum].toLowerCase();
                            totalCount++;
                            
                            if (userAnswer === correctAnswer) {
                                input.classList.remove('incorrect');
                                input.classList.add('correct');
                                correctCount++;
                            } else {
                                input.classList.remove('correct');
                                input.classList.add('incorrect');
                            }
                        }
                    });
                }
                
                // Mostrar resultado
                const percentage = totalCount > 0 ? Math.round((correctCount / totalCount) * 100) : 0;
                const resultDiv = exerciseContainer.querySelector('.exercise-result') || document.createElement('div');
                resultDiv.className = 'exercise-result';
                resultDiv.innerHTML = `
                    <div style="margin: 10px 0; padding: 10px; border-radius: 6px; ${percentage >= 70 ? 'background-color: #dcfce7; color: #16a34a;' : 'background-color: #fee2e2; color: #dc2626;'}">
                        <strong>Resultado: ${correctCount}/${totalCount} (${percentage}%)</strong>
                        ${percentage >= 70 ? ' 隆Excelente trabajo! ' : ' Sigue practicando '}
                    </div>
                `;
                
                if (!exerciseContainer.querySelector('.exercise-result')) {
                    exerciseContainer.appendChild(resultDiv);
                }
                
                // Registrar evaluaci贸n completada
                if (currentStudent) {
                    recordActivity('exercise_evaluated', {
                        exerciseId,
                        score: percentage,
                        correct: correctCount,
                        total: totalCount
                    });
                }
            };
            
            // Funci贸n global para mostrar respuestas
            window.showAnswers = (exerciseId) => {
                const exerciseContainer = Array.from(document.querySelectorAll('[data-exercise-answers]')).find(el => 
                    el.querySelector('.exercise-check-btn')
                );
                
                if (!exerciseContainer) return;
                
                const answers = JSON.parse(exerciseContainer.dataset.exerciseAnswers || '{}');
                const type = exerciseContainer.dataset.exerciseType;
                
                if (type === 'fill-in') {
                    const inputs = exerciseContainer.querySelectorAll('.exercise-input[data-answer]');
                    inputs.forEach(input => {
                        input.value = input.dataset.answer;
                        input.classList.remove('incorrect');
                        input.classList.add('correct');
                    });
                } else {
                    Object.keys(answers).forEach(questionNum => {
                        const input = exerciseContainer.querySelector(`input[data-question="${questionNum}"]`);
                        if (input) {
                            input.value = answers[questionNum];
                            input.classList.remove('incorrect');
                            input.classList.add('correct');
                        }
                    });
                }
            };
            
            // Registrar actividad del estudiante
            const recordActivity = (type, data) => {
                if (!currentStudent) return;
                
                const studentId = currentStudent.id;
                const today = new Date().toISOString().split('T')[0];
                
                setStudentProgress(prev => {
                    const current = prev[studentId] || { 
                        totalExercises: 0, 
                        vocabularyWords: 0, 
                        streak: 0, 
                        lastActivity: null,
                        activities: [] 
                    };
                    
                    const updated = { ...current };
                    
                    switch(type) {
                        case 'exercise_completed':
                            updated.totalExercises++;
                            updated.activities.push({ type, data, date: today });
                            break;
                        case 'word_added':
                            updated.vocabularyWords++;
                            updated.activities.push({ type, data, date: today });
                            break;
                    }
                    
                    // Calcular racha
                    if (updated.lastActivity !== today) {
                        const yesterday = new Date();
                        yesterday.setDate(yesterday.getDate() - 1);
                        const yesterdayStr = yesterday.toISOString().split('T')[0];
                        
                        if (updated.lastActivity === yesterdayStr) {
                            updated.streak++;
                        } else if (updated.lastActivity && updated.lastActivity !== today) {
                            updated.streak = 1;
                        } else {
                            updated.streak = 1;
                        }
                    }
                    
                    updated.lastActivity = today;
                    
                    // Verificar badges
                    checkBadges(studentId, updated);
                    
                    return { ...prev, [studentId]: updated };
                });
            };
            
            // Sistema de badges/insignias
            const checkBadges = (studentId, progress) => {
                const newBadges = [];
                const studentBadges = badges[studentId] || [];
                
                // Badge: Primera palabra
                if (progress.vocabularyWords >= 1 && !studentBadges.includes('first_word')) {
                    newBadges.push('first_word');
                }
                
                // Badge: 10 palabras
                if (progress.vocabularyWords >= 10 && !studentBadges.includes('vocab_master')) {
                    newBadges.push('vocab_master');
                }
                
                // Badge: Racha de 5 d铆as
                if (progress.streak >= 5 && !studentBadges.includes('streak_5')) {
                    newBadges.push('streak_5');
                }
                
                // Badge: 20 ejercicios
                if (progress.totalExercises >= 20 && !studentBadges.includes('exercise_master')) {
                    newBadges.push('exercise_master');
                }
                
                if (newBadges.length > 0) {
                    setBadges(prev => ({
                        ...prev,
                        [studentId]: [...(prev[studentId] || []), ...newBadges]
                    }));
                    
                    // Mostrar notificaci贸n de nuevo badge
                    newBadges.forEach(badge => {
                        const badgeNames = {
                            'first_word': ' Primera Palabra',
                            'vocab_master': ' Maestro del Vocabulario',
                            'streak_5': ' Racha de 5 D铆as',
                            'exercise_master': ' Maestro de Ejercicios'
                        };
                        
                        setTimeout(() => {
                            alert(`隆Felicidades! Has ganado la insignia: ${badgeNames[badge]}`);
                        }, 500);
                    });
                }
            };
            
            // Insertar template
            const insertTemplate = (template) => {
                if (editorRef.current) {
                    const editor = editorRef.current;
                    editor.focus();
                    
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = template.content;
                    
                    const selection = window.getSelection();
                    if (selection.rangeCount > 0) {
                        const range = selection.getRangeAt(0);
                        range.deleteContents();
                        
                        while (tempDiv.firstChild) {
                            range.insertNode(tempDiv.firstChild);
                        }
                        
                        range.collapse(false);
                        selection.removeAllRanges();
                        selection.addRange(range);
                    } else {
                        while (tempDiv.firstChild) {
                            editor.appendChild(tempDiv.firstChild);
                        }
                    }
                    
                    handleEditorChange();
                    setShowTemplateModal(false);
                    
                    editor.scrollTop = editor.scrollHeight;
                }
            };
            
            // Manejar pegado de im谩genes
            const handlePaste = (e) => {
                const items = Array.from(e.clipboardData.items);
                
                for (const item of items) {
                    if (item.type.indexOf('image') !== -1) {
                        e.preventDefault();
                        const blob = item.getAsFile();
                        const reader = new FileReader();
                        
                        reader.onload = (event) => {
                            const img = document.createElement('img');
                            img.src = event.target.result;
                            img.style.maxWidth = '100%';
                            img.style.height = 'auto';
                            img.style.margin = '10px 0';
                            img.style.border = '2px solid #e5e7eb';
                            img.style.borderRadius = '8px';
                            img.style.cursor = 'pointer';
                            
                            img.addEventListener('click', (e) => {
                                e.target.style.border = '2px solid #3b82f6';
                            });
                            
                            const selection = window.getSelection();
                            if (selection.rangeCount > 0) {
                                const range = selection.getRangeAt(0);
                                range.insertNode(img);
                                range.collapse(false);
                                selection.removeAllRanges();
                                selection.addRange(range);
                            }
                            
                            handleEditorChange();
                        };
                        
                        reader.readAsDataURL(blob);
                        break;
                    }
                }
            };
            
            // Drag and drop de im谩genes
            const handleDragOver = (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'copy';
            };
            
            const handleDrop = (e) => {
                e.preventDefault();
                const files = Array.from(e.dataTransfer.files);
                
                files.forEach(file => {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            const img = document.createElement('img');
                            img.src = event.target.result;
                            img.style.maxWidth = '100%';
                            img.style.height = 'auto';
                            img.style.margin = '10px 0';
                            img.style.border = '2px solid #e5e7eb';
                            img.style.borderRadius = '8px';
                            
                            if (editorRef.current) {
                                editorRef.current.appendChild(img);
                                handleEditorChange();
                            }
                        };
                        reader.readAsDataURL(file);
                    }
                });
            };
            
            // Gesti贸n de estudiantes
            const addStudent = () => {
                const name = prompt('Nombre del estudiante:');
                if (name && name.trim()) {
                    const colors = ['#EF4444', '#F59E0B', '#10B981', '#8B5CF6', '#F97316'];
                    const newStudent = {
                        id: Date.now(),
                        name: name.trim(),
                        level: prompt('Nivel del estudiante (A1, A2, B1, B2, C1, C2):') || 'A1',
                        isGroup: false,
                        members: [],
                        color: colors[students.length % colors.length]
                    };
                    const updatedStudents = [...students, newStudent];
                    setStudents(updatedStudents);
                    localStorage.setItem('espanol-prof-students', JSON.stringify(updatedStudents));
                }
            };
            
            const addGroup = () => {
                const name = prompt('Nombre del grupo:');
                if (name && name.trim()) {
                    const members = prompt('Nombres de los miembros (separados por coma):');
                    if (members && members.trim()) {
                        const colors = ['#EF4444', '#F59E0B', '#10B981', '#8B5CF6', '#F97316'];
                        const newGroup = {
                            id: Date.now(),
                            name: name.trim(),
                            level: prompt('Nivel del grupo (A1, A2, B1, B2, C1, C2):') || 'A1',
                            isGroup: true,
                            members: members.split(',').map(m => m.trim()).filter(m => m),
                            color: colors[students.length % colors.length]
                        };
                        const updatedStudents = [...students, newGroup];
                        setStudents(updatedStudents);
                        localStorage.setItem('espanol-prof-students', JSON.stringify(updatedStudents));
                    }
                }
            };
            
            // Chat colaborativo
            const sendMessage = () => {
                if (!newMessage.trim()) return;
                
                const message = {
                    id: Date.now(),
                    user: userName,
                    color: userColor,
                    text: newMessage,
                    timestamp: new Date().toLocaleTimeString()
                };
                
                setChatMessages([...chatMessages, message]);
                setNewMessage('');
            };
            
            // Funci贸n de pronunciaci贸n
            const speakText = (text, lang = 'es-ES') => {
                if ('speechSynthesis' in window) {
                    // Cancelar cualquier pronunciaci贸n en curso
                    window.speechSynthesis.cancel();
                    
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = lang;
                    utterance.rate = 0.9; // Velocidad un poco m谩s lenta para estudiantes
                    utterance.pitch = 1;
                    utterance.volume = 1;
                    
                    // Opcional: diferentes voces para Espa帽a/M茅xico
                    const voices = window.speechSynthesis.getVoices();
                    const spanishVoice = voices.find(voice => voice.lang === lang);
                    if (spanishVoice) {
                        utterance.voice = spanishVoice;
                    }
                    
                    window.speechSynthesis.speak(utterance);
                } else {
                    alert('Tu navegador no soporta s铆ntesis de voz');
                }
            };
            
            // Funciones de vocabulario
            const addVocabularyWord = () => {
                if (!currentStudent || !newWord.word.trim()) return;
                
                const studentVocab = vocabulary[currentStudent.id] || [];
                const updatedVocab = [...studentVocab, { ...newWord, id: Date.now() }];
                
                setVocabulary({
                    ...vocabulary,
                    [currentStudent.id]: updatedVocab
                });
                
                setNewWord({ word: '', definition: '', example: '' });
                setShowAddVocab(false);
                
                // Registrar actividad
                recordActivity('word_added', newWord.word);
                
                // Guardar en localStorage
                const data = {
                    sessions,
                    vocabulary: {
                        ...vocabulary,
                        [currentStudent.id]: updatedVocab
                    },
                    editorContent
                };
                localStorage.setItem('espanol-prof-data', JSON.stringify(data));
            };
            
            const deleteVocabularyWord = (wordId) => {
                if (!currentStudent) return;
                
                const studentVocab = vocabulary[currentStudent.id] || [];
                const updatedVocab = studentVocab.filter(word => word.id !== wordId);
                
                setVocabulary({
                    ...vocabulary,
                    [currentStudent.id]: updatedVocab
                });
            };
            
            // Exportaci贸n
            const exportToPDF = () => {
                // Generar secci贸n de vocabulario personal
                const vocabularySection = currentStudent && vocabulary[currentStudent.id] && vocabulary[currentStudent.id].length > 0
                    ? `
                        <div class="vocabulary-section">
                            <h3>Vocabulario Personal - ${currentStudent.name}</h3>
                            <div class="vocabulary-grid">
                                ${vocabulary[currentStudent.id].map(word => `
                                    <div class="vocabulary-item">
                                        <h4>${word.word}</h4>
                                        <p><strong>Definici贸n:</strong> ${word.definition}</p>
                                        ${word.example ? `<p><strong>Ejemplo:</strong> <em>"${word.example}"</em></p>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `
                    : '';

                const content = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="utf-8">
                        <title>Sesi贸n ${currentSession} - ${currentStudent?.name || 'General'}</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
                            .header { border-bottom: 2px solid #3b82f6; padding-bottom: 10px; margin-bottom: 20px; }
                            .content { margin: 20px 0; }
                            .session-info { background-color: #f9fafb; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #3b82f6; }
                            .vocabulary-section { background-color: #f0f9ff; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #0ea5e9; }
                            .vocabulary-grid { display: grid; gap: 15px; margin-top: 15px; }
                            .vocabulary-item { background-color: white; padding: 15px; border-radius: 6px; border: 1px solid #e0e7ff; }
                            .vocabulary-item h4 { margin: 0 0 8px 0; color: #1e40af; font-size: 18px; }
                            .vocabulary-item p { margin: 5px 0; }
                            table { border-collapse: collapse; width: 100%; margin: 10px 0; }
                            table, th, td { border: 1px solid #d1d5db; }
                            th, td { padding: 8px; text-align: left; }
                            th { background-color: #f3f4f6; }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1> Espa帽olProf - Sesi贸n ${currentSession}</h1>
                            <p><strong> Fecha:</strong> ${new Date(sessionDate).toLocaleDateString('es-ES', { 
                                weekday: 'long', 
                                year: 'numeric', 
                                month: 'long', 
                                day: 'numeric' 
                            })}</p>
                            <p><strong> Estudiante:</strong> ${currentStudent?.name || 'No seleccionado'}</p>
                            ${currentStudent?.isGroup ? `<p><strong> Miembros:</strong> ${currentStudent.members.join(', ')}</p>` : ''}
                            ${currentStudent?.level ? `<p><strong> Nivel:</strong> ${currentStudent.level}</p>` : ''}
                        </div>
                        
                        <div class="session-info">
                            <h3> Informaci贸n de la Sesi贸n</h3>
                            <p><strong> Objetivos:</strong> ${sessionData.objectives || 'No especificados'}</p>
                            <p><strong> Logros:</strong> ${sessionData.achievements || 'No registrados'}</p>
                            <p><strong> Progreso:</strong> ${sessionData.progress || 'No evaluado'}</p>
                            <p><strong> Notas:</strong> ${sessionData.notes || 'Sin notas adicionales'}</p>
                        </div>
                        
                        <div class="content">
                            <h3> Contenido del Trabajo</h3>
                            ${editorContent || '<p style="color: #6b7280; font-style: italic;">No hay contenido de trabajo registrado en esta sesi贸n.</p>'}
                        </div>
                        
                        ${vocabularySection}
                        
                        <div style="margin-top: 30px; padding-top: 15px; border-top: 1px solid #e5e7eb; color: #6b7280; font-size: 12px; text-align: center;">
                            <p>Documento generado por Espa帽olProf - ${new Date().toLocaleString('es-ES')}</p>
                        </div>
                    </body>
                    </html>
                `;
                
                const blob = new Blob([content], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `sesion-${currentSession}-${currentStudent?.name || 'general'}.html`;
                a.click();
                URL.revokeObjectURL(url);
            };
            
            // Conectar sala de colaboraci贸n
            const joinRoom = () => {
                const roomId = prompt('ID de la sala (comparte este ID con tus estudiantes):') || `sala-${Date.now()}`;
                setRoomId(roomId);
                setWebrtcConnected(true);
                alert(`Sala creada: ${roomId}\nComparte este ID con tus estudiantes para que se unan.`);
            };
            
            return (
                <div className="h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex flex-col">
                    {/* Header */}
                    <div className="bg-white shadow-lg border-b border-indigo-200 p-4">
                        <div className="flex items-center justify-between">
                            <div className="flex items-center gap-4">
                                <h1 className="text-2xl font-bold text-indigo-800">Espa帽olProf</h1>
                                <div className="flex items-center gap-2">
                                    <select 
                                        value={currentStudent?.id || ''} 
                                        onChange={(e) => setCurrentStudent(students.find(s => s.id == e.target.value))}
                                        className="px-3 py-2 border border-indigo-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                    >
                                        <option value="">Seleccionar estudiante</option>
                                        {students.map(student => (
                                            <option key={student.id} value={student.id}>
                                                {student.isGroup ? ` ${student.name}` : ` ${student.name}`}
                                            </option>
                                        ))}
                                    </select>
                                    <button onClick={addStudent} className="p-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600">
                                        <Icons.User />
                                    </button>
                                    <button onClick={addGroup} className="p-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600">
                                        <Icons.Users />
                                    </button>
                                </div>
                            </div>
                            
                            <div className="flex items-center gap-2">
                                <div className="flex items-center gap-1">
                                    <div className={`w-3 h-3 rounded-full animate-pulse ${webrtcConnected ? 'bg-green-500' : 'bg-gray-400'}`}></div>
                                    <span className="text-sm text-gray-600">
                                        {webrtcConnected ? `En l铆nea: ${collaborators.length + 1}` : 'Desconectado'}
                                    </span>
                                </div>
                                
                                <div className="flex items-center gap-2">
                                    <label className="text-sm text-gray-600">Fecha:</label>
                                    <input 
                                        type="date" 
                                        value={sessionDate}
                                        onChange={(e) => setSessionDate(e.target.value)}
                                        className="px-2 py-1 border border-indigo-300 rounded text-sm focus:ring-2 focus:ring-indigo-500"
                                    />
                                </div>
                                
                                <span className="text-lg font-medium text-indigo-700">Sesi贸n {currentSession}</span>
                                <input 
                                    type="number" 
                                    value={currentSession} 
                                    onChange={(e) => setCurrentSession(parseInt(e.target.value))}
                                    className="w-16 px-2 py-1 border border-indigo-300 rounded text-center"
                                    min="1"
                                />
                                
                                <div className="flex gap-1">
                                    <button 
                                        onClick={handleAuthClick}
                                        className={`p-2 text-white rounded-lg text-sm ${isSignedIn ? 'bg-green-500 hover:bg-green-600' : 'bg-blue-500 hover:bg-blue-600'}`}
                                        title={isSignedIn ? "Desconectar Google Drive" : "Conectar Google Drive"}
                                    >
                                        {isSignedIn ? '锔' : ''}
                                    </button>
                                    
                                    {isSignedIn && (
                                        <button 
                                            onClick={saveToGoogleDrive}
                                            className="p-2 bg-indigo-500 text-white rounded-lg text-sm hover:bg-indigo-600"
                                            title="Guardar en Google Drive"
                                        >
                                            
                                        </button>
                                        
                                        {currentStudent && (
                                            <button 
                                                onClick={() => saveSessionToGoogleDrive(currentStudent.name, currentSession, currentSessionContent)}
                                                className="p-2 bg-green-500 text-white rounded-lg text-sm hover:bg-green-600"
                                                title={`Guardar Sesi贸n ${currentSession} - ${currentStudent.name}`}
                                            >
                                                
                                            </button>
                                        )}
                                    )}
                                    
                                    <button 
                                        onClick={joinRoom}
                                        className={`p-2 text-white rounded-lg text-sm ${webrtcConnected ? 'bg-green-500' : 'bg-purple-500 hover:bg-purple-600'}`}
                                        title={webrtcConnected ? `Sala: ${roomId}` : "Crear sala de colaboraci贸n"}
                                    >
                                        {webrtcConnected ? '' : ''}
                                    </button>
                                </div>
                                
                                <button 
                                    onClick={() => setShowChat(!showChat)}
                                    className={`p-2 rounded-lg ${showChat ? 'bg-blue-500 text-white' : 'bg-gray-100'}`}
                                >
                                    <Icons.MessageCircle />
                                </button>
                                <button onClick={exportToPDF} className="p-2 bg-green-500 text-white rounded-lg hover:bg-green-600">
                                    <Icons.Download />
                                </button>
                                <button 
                                    onClick={() => setShowConfigModal(true)}
                                    className="p-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600"
                                    title="Configuraci贸n de API Keys"
                                >
                                    锔
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div className="flex-1 flex">
                        {/* Editor Principal */}
                        <div className="flex-1 p-4">
                            <div className="bg-white rounded-xl shadow-lg h-full flex flex-col">
                                {/* Barra de herramientas del editor */}
                                <div className="p-4 border-b border-gray-200">
                                    <div className="flex items-center gap-2 flex-wrap">
                                        <div className="flex items-center gap-1 border-r border-gray-300 pr-2">
                                            <button 
                                                onClick={() => applyFormat('bold')}
                                                className={`p-2 rounded ${textFormat.bold ? 'bg-indigo-500 text-white' : 'bg-gray-100 hover:bg-gray-200'}`}
                                            >
                                                <Icons.Bold />
                                            </button>
                                            <button 
                                                onClick={() => applyFormat('italic')}
                                                className={`p-2 rounded ${textFormat.italic ? 'bg-indigo-500 text-white' : 'bg-gray-100 hover:bg-gray-200'}`}
                                            >
                                                <Icons.Italic />
                                            </button>
                                            <button 
                                                onClick={() => applyFormat('underline')}
                                                className={`p-2 rounded ${textFormat.underline ? 'bg-indigo-500 text-white' : 'bg-gray-100 hover:bg-gray-200'}`}
                                            >
                                                <Icons.Underline />
                                            </button>
                                        </div>
                                        
                                        <select 
                                            onChange={(e) => applyFormat('fontSize', e.target.value)}
                                            className="px-2 py-1 border border-gray-300 rounded text-sm"
                                            defaultValue="16"
                                        >
                                            <option value="12">12px</option>
                                            <option value="14">14px</option>
                                            <option value="16">16px</option>
                                            <option value="18">18px</option>
                                            <option value="20">20px</option>
                                            <option value="24">24px</option>
                                            <option value="32">32px</option>
                                        </select>
                                        
                                        <input 
                                            type="color" 
                                            value={textFormat.color}
                                            onChange={(e) => {
                                                setTextFormat(prev => ({...prev, color: e.target.value}));
                                                applyFormat('foreColor', e.target.value);
                                            }}
                                            className="w-8 h-8 rounded border border-gray-300"
                                        />
                                        
                                        <div className="flex items-center gap-1 border-l border-gray-300 pl-2">
                                            <button onClick={() => applyFormat('justifyLeft')} className="p-2 bg-gray-100 rounded hover:bg-gray-200">
                                                <Icons.AlignLeft />
                                            </button>
                                            <button onClick={() => applyFormat('justifyCenter')} className="p-2 bg-gray-100 rounded hover:bg-gray-200">
                                                <Icons.AlignCenter />
                                            </button>
                                            <button onClick={() => applyFormat('justifyRight')} className="p-2 bg-gray-100 rounded hover:bg-gray-200">
                                                <Icons.AlignRight />
                                            </button>
                                        </div>
                                        
                                        <div className="flex items-center gap-1 border-l border-gray-300 pl-2">
                                            <button onClick={() => applyFormat('insertUnorderedList')} className="p-2 bg-gray-100 rounded hover:bg-gray-200">
                                                <Icons.List />
                                            </button>
                                            <button onClick={() => applyFormat('insertOrderedList')} className="p-2 bg-gray-100 rounded hover:bg-gray-200">
                                                <Icons.ListOrdered />
                                            </button>
                                        </div>
                                        
                                        <button 
                                            onClick={() => setShowTemplateModal(true)}
                                            className="p-2 bg-purple-500 text-white rounded hover:bg-purple-600 flex items-center gap-1"
                                        >
                                            <Icons.FileText />
                                            <span className="text-sm">Templates</span>
                                        </button>
                                        
                                        <button 
                                            onClick={() => applyFormat('removeFormat')}
                                            className="p-2 bg-red-500 text-white rounded hover:bg-red-600"
                                        >
                                            <Icons.Eraser />
                                        </button>
                                    </div>
                                </div>
                                
                                {/* Editor de contenido */}
                                <div className="flex-1 p-4">
                                    <div
                                        ref={editorRef}
                                        contentEditable
                                        onInput={handleEditorChange}
                                        onPaste={handlePaste}
                                        onDragOver={handleDragOver}
                                        onDrop={handleDrop}
                                        className="editor-content w-full h-full border border-gray-300 rounded-lg p-4 focus:outline-none focus:ring-2 focus:ring-indigo-500 overflow-y-auto"
                                        style={{ 
                                            minHeight: '400px',
                                            fontFamily: 'Arial, sans-serif',
                                            fontSize: '16px',
                                            lineHeight: '1.6'
                                        }}
                                        suppressContentEditableWarning={true}
                                        placeholder="Comienza a escribir o pega im谩genes aqu铆..."
                                    />
                                    
                                    <div className="mt-2 text-sm text-gray-500 flex items-center gap-4">
                                        <span> Ctrl+V para pegar im谩genes</span>
                                        <span>憋 Arrastra im谩genes desde tu computadora</span>
                                        <span> Usa los templates para ejercicios r谩pidos</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        {/* Panel lateral */}
                        <div className="w-96 p-4">
                            <div className="bg-white rounded-xl shadow-lg h-full flex flex-col">
                                <div className="p-4 border-b border-gray-200">
                                    <div className="flex gap-1 flex-wrap">
                                        <button 
                                            onClick={() => setActivePanel('session')}
                                            className={`px-2 py-1 rounded-lg text-xs ${activePanel === 'session' ? 'bg-indigo-500 text-white' : 'bg-gray-100'}`}
                                        >
                                            Sesi贸n
                                        </button>
                                        <button 
                                            onClick={() => setActivePanel('tools')}
                                            className={`px-2 py-1 rounded-lg text-xs ${activePanel === 'tools' ? 'bg-indigo-500 text-white' : 'bg-gray-100'}`}
                                        >
                                            IA
                                        </button>
                                        <button 
                                            onClick={() => setActivePanel('library')}
                                            className={`px-2 py-1 rounded-lg text-xs ${activePanel === 'library' ? 'bg-green-500 text-white' : 'bg-gray-100'}`}
                                        >
                                            Biblioteca
                                        </button>
                                        <button 
                                            onClick={() => setActivePanel('vocab')}
                                            className={`px-2 py-1 rounded-lg text-xs ${activePanel === 'vocab' ? 'bg-indigo-500 text-white' : 'bg-gray-100'}`}
                                        >
                                            Vocabulario
                                        </button>
                                        <button 
                                            onClick={() => setActivePanel('progress')}
                                            className={`px-2 py-1 rounded-lg text-xs ${activePanel === 'progress' ? 'bg-purple-500 text-white' : 'bg-gray-100'}`}
                                        >
                                            Progreso
                                        </button>
                                    </div>
                                </div>
                                
                                <div className="flex-1 p-4 overflow-y-auto">
                                    {activePanel === 'session' && (
                                        <div className="space-y-4">
                                            <div>
                                                <h3 className="font-semibold text-gray-800 mb-2">Informaci贸n de la Sesi贸n</h3>
                                                <div className="bg-blue-50 p-3 rounded-lg mb-3">
                                                    <p className="text-sm"><strong>Fecha:</strong> {new Date(sessionDate).toLocaleDateString('es-ES', { 
                                                        weekday: 'long', 
                                                        year: 'numeric', 
                                                        month: 'long', 
                                                        day: 'numeric' 
                                                    })}</p>
                                                    <p className="text-sm"><strong>Sesi贸n:</strong> #{currentSession}</p>
                                                </div>
                                            </div>
                                            
                                            <div>
                                                <h3 className="font-semibold text-gray-800 mb-2">Informaci贸n del Estudiante</h3>
                                                {currentStudent ? (
                                                    <div className="bg-indigo-50 p-3 rounded-lg">
                                                        <div className="flex items-center gap-2">
                                                            <div 
                                                                className="w-4 h-4 rounded-full"
                                                                style={{ backgroundColor: currentStudent.color }}
                                                            ></div>
                                                            <p className="font-medium">{currentStudent.name}</p>
                                                        </div>
                                                        <p className="text-sm text-gray-600">Nivel: {currentStudent.level}</p>
                                                        {currentStudent.isGroup && (
                                                            <p className="text-sm text-gray-600">
                                                                Miembros: {currentStudent.members.join(', ')}
                                                            </p>
                                                        )}
                                                    </div>
                                                ) : (
                                                    <p className="text-gray-500">Selecciona un estudiante</p>
                                                )}
                                            </div>
                                            
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">Objetivos de la sesi贸n</label>
                                                <textarea 
                                                    value={sessionData.objectives}
                                                    onChange={(e) => setSessionData({...sessionData, objectives: e.target.value})}
                                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                                    rows="3"
                                                    placeholder="驴Qu茅 queremos lograr hoy?"
                                                />
                                            </div>
                                            
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">Logros alcanzados</label>
                                                <textarea 
                                                    value={sessionData.achievements}
                                                    onChange={(e) => setSessionData({...sessionData, achievements: e.target.value})}
                                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                                    rows="3"
                                                    placeholder="驴Qu茅 hemos conseguido?"
                                                />
                                            </div>
                                            
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">Progreso observado</label>
                                                <textarea 
                                                    value={sessionData.progress}
                                                    onChange={(e) => setSessionData({...sessionData, progress: e.target.value})}
                                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                                    rows="3"
                                                    placeholder="驴C贸mo evoluciona el estudiante?"
                                                />
                                            </div>
                                            
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">Notas adicionales</label>
                                                <textarea 
                                                    value={sessionData.notes}
                                                    onChange={(e) => setSessionData({...sessionData, notes: e.target.value})}
                                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                                    rows="3"
                                                    placeholder="Observaciones, tareas, etc."
                                                />
                                            </div>
                                        </div>
                                    )}
                                    
                                    {activePanel === 'tools' && (
                                        <div className="space-y-4">
                                            <div>
                                                <h3 className="font-semibold text-gray-800 mb-3">Ejercicios con IA</h3>
                                                <div className="space-y-2">
                                                    {['conjugation', 'vocabulary', 'completion', 'conversation'].map(type => (
                                                        <button 
                                                            key={type}
                                                            onClick={async () => {
                                                                if (!currentStudent) {
                                                                    alert('Por favor, selecciona un estudiante primero');
                                                                    return;
                                                                }
                                                                setIsGeneratingExercise(true);
                                                                const exercise = await generateExerciseWithAI(type, currentStudent.level);
                                                                setIsGeneratingExercise(false);
                                                                if (exercise && editorRef.current) {
                                                                    const div = document.createElement('div');
                                                                    div.innerHTML = `<div style="border: 2px solid #6366f1; padding: 16px; margin: 16px 0; border-radius: 8px; background-color: #f3f4f6;">
                                                                        <h3 style="color: #4f46e5; margin-bottom: 12px;">Ejercicio Generado con IA</h3>
                                                                        ${exercise}
                                                                    </div>`;
                                                                    editorRef.current.appendChild(div);
                                                                    handleEditorChange();
                                                                }
                                                            }}
                                                            disabled={isGeneratingExercise}
                                                            className="w-full p-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg hover:from-purple-600 hover:to-pink-600 disabled:opacity-50 text-sm"
                                                        >
                                                            {isGeneratingExercise ? 'Generando...' : 
                                                             type === 'conjugation' ? 'Ejercicio de Conjugaci贸n' :
                                                             type === 'vocabulary' ? 'Ejercicio de Vocabulario' :
                                                             type === 'completion' ? 'Completar Frases' :
                                                             'Di谩logo y Comprensi贸n'}
                                                        </button>
                                                    ))}
                                                </div>
                                            </div>
                                            
                                            <div>
                                                <h3 className="font-semibold text-gray-800 mb-3">Conjugador de Verbos con IA</h3>
                                                <div className="space-y-2">
                                                    <input 
                                                        type="text" 
                                                        placeholder="Escribe un verbo..."
                                                        value={verbToConjugate}
                                                        onChange={(e) => setVerbToConjugate(e.target.value)}
                                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                                                    />
                                                    <select 
                                                        value={selectedTense}
                                                        onChange={(e) => setSelectedTense(e.target.value)}
                                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                                                    >
                                                        <option>Presente</option>
                                                        <option>Pret茅rito</option>
                                                        <option>Futuro</option>
                                                        <option>Subjuntivo</option>
                                                        <option>Imperfecto</option>
                                                        <option>Condicional</option>
                                                    </select>
                                                    <button 
                                                        onClick={async () => {
                                                            if (!verbToConjugate.trim()) return;
                                                            setConjugationResult('Conjugando...');
                                                            const result = await conjugateVerb(verbToConjugate, selectedTense);
                                                            setConjugationResult(result || 'Error al conjugar');
                                                        }}
                                                        className="w-full p-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600"
                                                    >
                                                        Conjugar
                                                    </button>
                                                    {conjugationResult && (
                                                        <div className="bg-indigo-50 p-3 rounded-lg mt-2">
                                                            <pre className="text-sm whitespace-pre-wrap">{conjugationResult}</pre>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                            
                                            <div>
                                                <h3 className="font-semibold text-gray-800 mb-3">Estado de Conectividad</h3>
                                                <div className="space-y-3">
                                                    <div className="bg-gray-50 p-3 rounded-lg">
                                                        <div className="flex items-center justify-between">
                                                            <span className="text-sm font-medium">Google Drive</span>
                                                            <span className={`text-xs px-2 py-1 rounded ${
                                                                syncStatus === 'synced' ? 'bg-green-100 text-green-700' : 
                                                                syncStatus === 'syncing' ? 'bg-yellow-100 text-yellow-700' :
                                                                syncStatus === 'error' ? 'bg-red-100 text-red-700' :
                                                                'bg-gray-100 text-gray-700'
                                                            }`}>
                                                                {syncStatus === 'synced' ? 'Sincronizado' : 
                                                                 syncStatus === 'syncing' ? 'Sincronizando...' :
                                                                 syncStatus === 'error' ? 'Error' :
                                                                 'Desconectado'}
                                                            </span>
                                                        </div>
                                                        {isSignedIn && (
                                                            <div className="mt-2">
                                                                <p className="text-xs text-gray-600">Sincronizaci贸n autom谩tica activada</p>
                                                                <button 
                                                                    onClick={() => setShowDriveFiles(true)}
                                                                    className="text-xs text-indigo-600 hover:text-indigo-800 mt-1"
                                                                >
                                                                    Ver archivos guardados ({driveFiles.length})
                                                                </button>
                                                            </div>
                                                        )}
                                                    </div>
                                                    
                                                    <div className="bg-gray-50 p-3 rounded-lg">
                                                        <div className="flex items-center justify-between">
                                                            <span className="text-sm font-medium">Colaboraci贸n</span>
                                                            <span className={`text-xs px-2 py-1 rounded ${webrtcConnected ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                                                {webrtcConnected ? 'Activa' : 'Inactiva'}
                                                            </span>
                                                        </div>
                                                        {webrtcConnected && roomId && (
                                                            <p className="text-xs text-gray-600 mt-1">Sala: {roomId}</p>
                                                        )}
                                                    </div>
                                                    
                                                    {webrtcConnected && collaborators.length > 0 && (
                                                        <div className="bg-blue-50 p-3 rounded-lg">
                                                            <p className="text-sm font-medium mb-2">Participantes:</p>
                                                            {collaborators.map(collab => (
                                                                <div key={collab.id} className="flex items-center gap-2 text-sm">
                                                                    <div 
                                                                        className="w-3 h-3 rounded-full"
                                                                        style={{ backgroundColor: collab.color }}
                                                                    ></div>
                                                                    <span>{collab.name}</span>
                                                                    <span className="text-xs text-gray-500">
                                                                        {Date.now() - collab.lastUpdate < 5000 ? '' : ''}
                                                                    </span>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                    
                                    {activePanel === 'library' && (
                                        <div className="space-y-4">
                                            <h3 className="font-semibold text-gray-800 mb-3"> Biblioteca de Ejercicios</h3>
                                            
                                            {currentStudent && exerciseLibrary[currentStudent.level] ? (
                                                <div className="space-y-3">
                                                    <p className="text-sm text-green-600">
                                                        Ejercicios disponibles para nivel {currentStudent.level}:
                                                    </p>
                                                    
                                                    {/* Ejercicios de vocabulario */}
                                                    {exerciseLibrary[currentStudent.level].vocabulary && (
                                                        <div>
                                                            <h4 className="font-medium text-gray-700 mb-2">Vocabulario</h4>
                                                            {exerciseLibrary[currentStudent.level].vocabulary.map(exercise => (
                                                                <button
                                                                    key={exercise.id}
                                                                    onClick={() => insertLibraryExercise(exercise)}
                                                                    className="w-full text-left p-2 bg-green-50 hover:bg-green-100 rounded border border-green-200 mb-1"
                                                                >
                                                                    <div className="font-medium text-green-800">{exercise.title}</div>
                                                                </button>
                                                            ))}
                                                        </div>
                                                    )}
                                                    
                                                    {/* Ejercicios de conjugaci贸n */}
                                                    {exerciseLibrary[currentStudent.level].conjugation && (
                                                        <div>
                                                            <h4 className="font-medium text-gray-700 mb-2">Conjugaci贸n</h4>
                                                            {exerciseLibrary[currentStudent.level].conjugation.map(exercise => (
                                                                <button
                                                                    key={exercise.id}
                                                                    onClick={() => insertLibraryExercise(exercise)}
                                                                    className="w-full text-left p-2 bg-blue-50 hover:bg-blue-100 rounded border border-blue-200 mb-1"
                                                                >
                                                                    <div className="font-medium text-blue-800">{exercise.title}</div>
                                                                </button>
                                                            ))}
                                                        </div>
                                                    )}
                                                    
                                                    {/* Ejercicios de completar */}
                                                    {exerciseLibrary[currentStudent.level].completion && (
                                                        <div>
                                                            <h4 className="font-medium text-gray-700 mb-2">Completar</h4>
                                                            {exerciseLibrary[currentStudent.level].completion.map(exercise => (
                                                                <button
                                                                    key={exercise.id}
                                                                    onClick={() => insertLibraryExercise(exercise)}
                                                                    className="w-full text-left p-2 bg-purple-50 hover:bg-purple-100 rounded border border-purple-200 mb-1"
                                                                >
                                                                    <div className="font-medium text-purple-800">{exercise.title}</div>
                                                                </button>
                                                            ))}
                                                        </div>
                                                    )}
                                                </div>
                                            ) : (
                                                <p className="text-gray-500 text-center py-4">
                                                    {!currentStudent ? 'Selecciona un estudiante' : `No hay ejercicios disponibles para nivel ${currentStudent.level}`}
                                                </p>
                                            )}
                                        </div>
                                    )}
                                    
                                    {activePanel === 'progress' && (
                                        <div className="space-y-4">
                                            <h3 className="font-semibold text-gray-800 mb-3"> Progreso del Estudiante</h3>
                                            
                                            {currentStudent && studentProgress[currentStudent.id] ? (
                                                <div className="space-y-4">
                                                    <div className="bg-purple-50 p-3 rounded-lg">
                                                        <h4 className="font-medium text-purple-800 mb-2">Estad铆sticas</h4>
                                                        <div className="grid grid-cols-2 gap-2 text-sm">
                                                            <div>
                                                                <span className="text-gray-600">Ejercicios:</span>
                                                                <span className="ml-2 font-bold">{studentProgress[currentStudent.id].totalExercises}</span>
                                                            </div>
                                                            <div>
                                                                <span className="text-gray-600">Vocabulario:</span>
                                                                <span className="ml-2 font-bold">{studentProgress[currentStudent.id].vocabularyWords}</span>
                                                            </div>
                                                            <div>
                                                                <span className="text-gray-600">Racha:</span>
                                                                <span className="ml-2 font-bold">{studentProgress[currentStudent.id].streak} d铆as</span>
                                                            </div>
                                                            <div>
                                                                <span className="text-gray-600">ltima vez:</span>
                                                                <span className="ml-2 font-bold text-xs">{studentProgress[currentStudent.id].lastActivity}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <div className="bg-yellow-50 p-3 rounded-lg">
                                                        <h4 className="font-medium text-yellow-800 mb-2"> Insignias</h4>
                                                        <div className="flex flex-wrap gap-1">
                                                            {badges[currentStudent.id] && badges[currentStudent.id].length > 0 ? (
                                                                badges[currentStudent.id].map(badge => {
                                                                    const badgeInfo = {
                                                                        'first_word': '',
                                                                        'vocab_master': '',
                                                                        'streak_5': '',
                                                                        'exercise_master': ''
                                                                    };
                                                                    return (
                                                                        <span key={badge} className="text-2xl" title={badge}>
                                                                            {badgeInfo[badge]}
                                                                        </span>
                                                                    );
                                                                })
                                                            ) : (
                                                                <span className="text-gray-500 text-sm">A煤n no hay insignias</span>
                                                            )}
                                                        </div>
                                                    </div>
                                                </div>
                                            ) : (
                                                <p className="text-gray-500 text-center py-4">
                                                    {!currentStudent ? 'Selecciona un estudiante para ver su progreso' : 'No hay datos de progreso a煤n'}
                                                </p>
                                            )}
                                        </div>
                                    )}
                                    
                                    {activePanel === 'vocab' && (
                                        <div className="space-y-4">
                                            <div className="flex justify-between items-center">
                                                <h3 className="font-semibold text-gray-800">Vocabulario Personal</h3>
                                                <button 
                                                    onClick={() => setShowAddVocab(true)}
                                                    disabled={!currentStudent}
                                                    className="p-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 disabled:opacity-50"
                                                >
                                                    <Icons.Plus />
                                                </button>
                                            </div>
                                            
                                            <div className="space-y-2">
                                                {currentStudent && vocabulary[currentStudent.id] && vocabulary[currentStudent.id].map((word) => (
                                                    <div key={word.id} className="bg-gray-50 p-3 rounded-lg relative">
                                                        <button 
                                                            onClick={() => deleteVocabularyWord(word.id)}
                                                            className="absolute top-2 right-2 text-red-500 hover:text-red-700 text-xs"
                                                        >
                                                            
                                                        </button>
                                                        <div className="flex items-center gap-2">
                                                            <div className="font-medium text-gray-800">{word.word}</div>
                                                            <button 
                                                                onClick={() => speakText(word.word)}
                                                                className="p-1 bg-blue-100 hover:bg-blue-200 rounded text-blue-600 transition-colors"
                                                                title="Escuchar pronunciaci贸n"
                                                            >
                                                                
                                                            </button>
                                                        </div>
                                                        <div className="text-sm text-gray-600">{word.definition}</div>
                                                        {word.example && (
                                                            <div className="text-sm text-indigo-600 italic">
                                                                "{word.example}"
                                                                <button 
                                                                    onClick={() => speakText(word.example)}
                                                                    className="ml-2 p-1 text-xs bg-indigo-100 hover:bg-indigo-200 rounded text-indigo-600"
                                                                    title="Escuchar ejemplo"
                                                                >
                                                                    
                                                                </button>
                                                            </div>
                                                        )}
                                                    </div>
                                                ))}
                                                {(!currentStudent || !vocabulary[currentStudent.id] || vocabulary[currentStudent.id].length === 0) && (
                                                    <p className="text-gray-500 text-center py-4">
                                                        {!currentStudent ? 'Selecciona un estudiante' : 'No hay vocabulario guardado'}
                                                    </p>
                                                )}
                                            </div>
                                            
                                            {showAddVocab && (
                                                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                                                    <div className="bg-white rounded-xl p-6 max-w-md w-full m-4">
                                                        <h3 className="text-lg font-bold mb-4">Agregar Nueva Palabra</h3>
                                                        <div className="space-y-3">
                                                            <input 
                                                                type="text"
                                                                placeholder="Palabra..."
                                                                value={newWord.word}
                                                                onChange={(e) => setNewWord({...newWord, word: e.target.value})}
                                                                className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                                                            />
                                                            <textarea 
                                                                placeholder="Definici贸n..."
                                                                value={newWord.definition}
                                                                onChange={(e) => setNewWord({...newWord, definition: e.target.value})}
                                                                className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                                                                rows="2"
                                                            />
                                                            <input 
                                                                type="text"
                                                                placeholder="Ejemplo (opcional)..."
                                                                value={newWord.example}
                                                                onChange={(e) => setNewWord({...newWord, example: e.target.value})}
                                                                className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                                                            />
                                                        </div>
                                                        <div className="flex gap-2 mt-4">
                                                            <button 
                                                                onClick={() => setShowAddVocab(false)}
                                                                className="flex-1 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600"
                                                            >
                                                                Cancelar
                                                            </button>
                                                            <button 
                                                                onClick={addVocabularyWord}
                                                                className="flex-1 px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600"
                                                            >
                                                                Agregar
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                                
                                <div className="p-4 border-t border-gray-200">
                                    <div className="cursor-pointer">
                                        <div className="font-semibold text-gray-800 flex items-center gap-2 mb-3">
                                            <Icons.Calendar />
                                            Reservar Pr贸xima Clase
                                        </div>
                                        <div className="bg-blue-50 p-4 rounded-lg">
                                            <p className="text-sm text-gray-600 mb-3">
                                                Permite que tus estudiantes reserven su pr贸xima clase directamente
                                            </p>
                                            <div id="google-calendar-scheduling"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        {showChat && (
                            <div className="w-80 p-4">
                                <div className="bg-white rounded-xl shadow-lg h-full flex flex-col">
                                    <div className="p-4 border-b border-gray-200">
                                        <h3 className="font-semibold text-gray-800 flex items-center gap-2">
                                            <Icons.MessageCircle />
                                            Chat Colaborativo
                                        </h3>
                                    </div>
                                    
                                    <div className="flex-1 p-4 overflow-y-auto space-y-2">
                                        {chatMessages.map(msg => (
                                            <div key={msg.id} className="flex items-start gap-2">
                                                <div 
                                                    className="w-6 h-6 rounded-full flex-shrink-0 flex items-center justify-center text-white text-xs font-medium"
                                                    style={{ backgroundColor: msg.color }}
                                                >
                                                    {msg.user[0]}
                                                </div>
                                                <div className="flex-1">
                                                    <div className="flex items-center gap-2">
                                                        <span className="text-sm font-medium">{msg.user}</span>
                                                        <span className="text-xs text-gray-500">{msg.timestamp}</span>
                                                    </div>
                                                    <p className="text-sm text-gray-700">{msg.text}</p>
                                                </div>
                                            </div>
                                        ))}
                                        {chatMessages.length === 0 && (
                                            <p className="text-gray-500 text-center py-4">No hay mensajes a煤n</p>
                                        )}
                                    </div>
                                    
                                    <div className="p-4 border-t border-gray-200">
                                        <div className="flex gap-2">
                                            <input 
                                                type="text"
                                                value={newMessage}
                                                onChange={(e) => setNewMessage(e.target.value)}
                                                onKeyPress={(e) => e.key === 'Enter' && sendMessage()}
                                                placeholder="Escribe un mensaje..."
                                                className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                            />
                                            <button 
                                                onClick={sendMessage}
                                                className="p-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600"
                                            >
                                                <Icons.ArrowRight />
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                    
                    {showTemplateModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white rounded-xl p-6 max-w-2xl w-full m-4 max-h-96 overflow-y-auto">
                                <h3 className="text-xl font-bold mb-4">Seleccionar Template</h3>
                                <div className="grid gap-4">
                                    {templates.map(template => (
                                        <div key={template.id} className="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 cursor-pointer"
                                             onClick={() => insertTemplate(template)}>
                                            <h4 className="font-semibold text-gray-800">{template.name}</h4>
                                            <div className="text-sm text-gray-600 mt-2">
                                                {template.content.replace(/<[^>]*>/g, '').substring(0, 100)}...
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                <div className="flex justify-end gap-2 mt-4">
                                    <button onClick={() => setShowTemplateModal(false)} className="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                                        Cancelar
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {showDriveFiles && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white rounded-xl p-6 max-w-2xl w-full m-4 max-h-[600px] overflow-hidden flex flex-col">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-xl font-bold">Archivos en Google Drive</h3>
                                    <button 
                                        onClick={() => {
                                            loadDriveFiles();
                                        }}
                                        className="p-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600"
                                        title="Actualizar lista"
                                    >
                                        
                                    </button>
                                </div>
                                
                                <div className="flex-1 overflow-y-auto">
                                    {driveFiles.length > 0 ? (
                                        <div className="space-y-2">
                                            {driveFiles.map(file => (
                                                <div 
                                                    key={file.id} 
                                                    className="border border-gray-200 rounded-lg p-3 hover:bg-gray-50 flex justify-between items-center"
                                                >
                                                    <div>
                                                        <h4 className="font-medium text-gray-800">{file.name}</h4>
                                                        <p className="text-xs text-gray-500">
                                                            Modificado: {new Date(file.modifiedTime).toLocaleString('es-ES')}
                                                        </p>
                                                    </div>
                                                    <button 
                                                        onClick={() => {
                                                            loadFromGoogleDrive(file.id);
                                                            setShowDriveFiles(false);
                                                        }}
                                                        className="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 text-sm"
                                                    >
                                                        Cargar
                                                    </button>
                                                </div>
                                            ))}
                                        </div>
                                    ) : (
                                        <div className="text-center py-8 text-gray-500">
                                            <p>No hay archivos guardados en Google Drive</p>
                                            <p className="text-sm mt-2">Los archivos se guardar谩n autom谩ticamente cada 30 segundos</p>
                                        </div>
                                    )}
                                </div>
                                
                                <div className="flex justify-end gap-2 mt-4 pt-4 border-t">
                                    <button 
                                        onClick={() => setShowDriveFiles(false)} 
                                        className="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600"
                                    >
                                        Cerrar
                                    </button>
                                    <button 
                                        onClick={saveToGoogleDrive} 
                                        className="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600"
                                    >
                                        Guardar ahora
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {showConfigModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white rounded-xl p-6 max-w-2xl w-full m-4">
                                <h3 className="text-xl font-bold mb-4">Configuraci贸n de API Keys</h3>
                                <p className="text-sm text-gray-600 mb-4">
                                    Para mantener tus claves seguras, ingresa tus propias API keys. Se guardar谩n localmente en tu navegador.
                                </p>
                                
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Google Client ID</label>
                                        <input 
                                            type="text"
                                            value={configKeys.googleClientId}
                                            onChange={(e) => setConfigKeys({...configKeys, googleClientId: e.target.value})}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                            placeholder="Tu Client ID de Google"
                                        />
                                        <p className="text-xs text-gray-500 mt-1">Obtenlo en Google Cloud Console</p>
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Google API Key</label>
                                        <input 
                                            type="text"
                                            value={configKeys.googleApiKey}
                                            onChange={(e) => setConfigKeys({...configKeys, googleApiKey: e.target.value})}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                            placeholder="Tu API Key de Google"
                                        />
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">OpenAI API Key</label>
                                        <input 
                                            type="password"
                                            value={configKeys.openaiApiKey}
                                            onChange={(e) => setConfigKeys({...configKeys, openaiApiKey: e.target.value})}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                            placeholder="sk-..."
                                        />
                                        <p className="text-xs text-gray-500 mt-1">Tu clave de OpenAI (se muestra oculta por seguridad)</p>
                                    </div>
                                </div>
                                
                                <div className="mt-6 bg-blue-50 p-3 rounded-lg">
                                    <p className="text-sm text-blue-800">
                                        <strong>Nota de seguridad:</strong> Las claves se guardan solo en tu navegador local. 
                                        Nunca se env铆an a ning煤n servidor.
                                    </p>
                                </div>
                                
                                <div className="flex justify-end gap-2 mt-6">
                                    <button 
                                        onClick={() => setShowConfigModal(false)}
                                        className="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600"
                                    >
                                        Cancelar
                                    </button>
                                    <button 
                                        onClick={() => {
                                            // Guardar en localStorage
                                            localStorage.setItem('GOOGLE_CLIENT_ID', configKeys.googleClientId);
                                            localStorage.setItem('GOOGLE_API_KEY', configKeys.googleApiKey);
                                            localStorage.setItem('OPENAI_API_KEY', configKeys.openaiApiKey);
                                            setShowConfigModal(false);
                                            alert('Configuraci贸n guardada. Por favor, recarga la p谩gina para aplicar los cambios.');
                                            window.location.reload();
                                        }}
                                        className="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600"
                                    >
                                        Guardar y Recargar
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // Renderizar la aplicaci贸n (React 18 compatible)
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<EspanolProfApp />);
        
        // Cargar el bot贸n de Google Calendar despu茅s del render
        window.addEventListener('load', function() {
            if (window.calendar && window.calendar.schedulingButton) {
                calendar.schedulingButton.load({
                    url: 'https://calendar.google.com/calendar/appointments/schedules/AcZssZ3k8Nqb3O4Dd1xEC69SA5gFfqV2xxFsuXvweCebg57ownKw-B8grxvKSjJ3nO5y3kmK-kBA-qmR?gv=true',
                    color: '#039BE5',
                    label: 'Reservar una cita',
                    target: document.getElementById('google-calendar-scheduling'),
                });
            }
        });
    </script>
</body>
</html>
